{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="settings-section">
        <h2 class="settings-title">
            <i class="fas fa-cog"></i>
            {{ translations.settings.title }}
        </h2>
        
        <form id="settingsForm" class="settings-form" onsubmit="return handleSettingsUpdate(event)">
            <div class="form-group">
                <label for="newUsername">
                    <i class="fas fa-user"></i>
                    {{ translations.settings.new_username }}
                </label>
                <input type="text" id="newUsername" name="newUsername" placeholder="Enter new username" required>
            </div>
            
            <div class="form-group">
                <label for="currentPassword">
                    <i class="fas fa-lock"></i>
                    {{ translations.settings.current_password }}
                </label>
                <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password to confirm changes" required>
            </div>
            
            <div class="form-group">
                <label for="newPassword">
                    <i class="fas fa-key"></i>
                    {{ translations.settings.new_password }}
                </label>
                <input type="password" id="newPassword" name="newPassword" placeholder="Leave empty to keep current password">
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">
                    <i class="fas fa-key"></i>
                    {{ translations.settings.confirm_password }}
                </label>
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
            </div>
            
            <button type="submit" class="settings-button btn-primary">
                <i class="fas fa-save"></i>
                {{ translations.settings.save_button }}
            </button>
            
            <div id="settingsError" class="message error" style="display: none;"></div>
            <div id="settingsSuccess" class="message success" style="display: none;"></div>
        </form>
        
        <!-- CSV Export Section -->
        <div class="export-section">
            <h3 class="export-title">
                <i class="fas fa-download"></i>
                {{ translations.settings.export.title }}
            </h3>
            <p class="export-description">
                {{ translations.settings.export.description }}
            </p>
            <button type="button" id="exportCsvBtn" class="export-button btn-secondary" onclick="exportSchedulesCSV()">
                <i class="fas fa-file-csv"></i>
                {{ translations.settings.export.button }}
            </button>
            <div id="exportStatus" class="message" style="display: none;"></div>
        </div>
        
        <!-- CSV Import Section -->
        <div class="import-section">
            <h3 class="import-title">
                <i class="fas fa-upload"></i>
                {{ translations.settings.import.title }}
            </h3>
            <p class="import-description">
                {{ translations.settings.import.description }}
            </p>
            <div class="import-form">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFileInput" accept=".csv" class="file-input">
                    <label for="csvFileInput" class="file-input-label">
                        <i class="fas fa-file-csv"></i>
                        {{ translations.settings.import.choose_file }}
                    </label>
                    <span id="fileName" class="file-name"></span>
                </div>
                <button type="button" id="importCsvBtn" class="import-button btn-primary" onclick="importSchedulesCSV()" disabled>
                    <i class="fas fa-upload"></i>
                    {{ translations.settings.import.button }}
                </button>
            </div>
            <div id="importStatus" class="message" style="display: none;"></div>
            <div class="import-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>{{ translations.settings.import.warning }}</strong>
            </div>
        </div>
    </div>
</div>

<script>
    async function handleSettingsUpdate(event) {
        event.preventDefault();
        const newUsername = document.getElementById('newUsername').value;
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorDiv = document.getElementById('settingsError');
        const successDiv = document.getElementById('settingsSuccess');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        if (newPassword && newPassword !== confirmPassword) {
            errorDiv.textContent = '{{ translations.settings.password_mismatch }}';
            errorDiv.style.display = 'block';
            return false;
        }

        try {
            const response = await fetch('/settings/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    newUsername,
                    currentPassword,
                    newPassword
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                successDiv.textContent = '{{ translations.settings.update_success }}';
                successDiv.style.display = 'block';
                if (data.requireRelogin) {
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                }
            } else {
                errorDiv.textContent = data.error || '{{ translations.settings.update_error }}';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = '{{ translations.settings.server_error }}';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    async function exportSchedulesCSV() {
        const exportBtn = document.getElementById('exportCsvBtn');
        const statusDiv = document.getElementById('exportStatus');
        
        // Show loading state
        exportBtn.disabled = true;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ translations.settings.import.exporting }}';
        statusDiv.style.display = 'none';
        
        try {
            const response = await fetch('/settings/export_csv');
            
            if (response.ok) {
                // Check if response is JSON (error) or CSV (success)
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    // Handle JSON error response
                    const data = await response.json();
                    statusDiv.textContent = data.error || '{{ translations.settings.export.error }}';
                    statusDiv.className = 'message error';
                    statusDiv.style.display = 'block';
                } else {
                    // Handle CSV file download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    // Get filename from response headers
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = 'audio_schedules.csv';
                    if (contentDisposition) {
                        const matches = contentDisposition.match(/filename="([^"]+)"/);
                        if (matches) {
                            filename = matches[1];
                        }
                    }
                    
                    // Create download link and trigger download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message
                    statusDiv.textContent = '{{ translations.settings.export.success }}';
                    statusDiv.className = 'message success';
                    statusDiv.style.display = 'block';
                }
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        } catch (error) {
            console.error('Export error:', error);
            statusDiv.textContent = '{{ translations.settings.export.error }}: ' + error.message;
            statusDiv.className = 'message error';
            statusDiv.style.display = 'block';
        } finally {
            // Restore button state
            exportBtn.disabled = false;
            exportBtn.innerHTML = '<i class="fas fa-file-csv"></i> {{ translations.settings.export.button }}';
            
            // Hide status message after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }
    
    // File input handling
    document.getElementById('csvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileName = document.getElementById('fileName');
        const importBtn = document.getElementById('importCsvBtn');
        
        if (file) {
            fileName.textContent = file.name;
            importBtn.disabled = false;
        } else {
            fileName.textContent = '';
            importBtn.disabled = true;
        }
    });
    
    async function importSchedulesCSV() {
        const fileInput = document.getElementById('csvFileInput');
        const importBtn = document.getElementById('importCsvBtn');
        const statusDiv = document.getElementById('importStatus');
        
        if (!fileInput.files[0]) {
            statusDiv.textContent = '{{ translations.settings.import.select_file_error }}';
            statusDiv.className = 'message error';
            statusDiv.style.display = 'block';
            return;
        }
        
        const file = fileInput.files[0];
        
        // Show loading state
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ translations.settings.import.importing }}';
        statusDiv.style.display = 'none';
        
        try {
            const formData = new FormData();
            formData.append('csv_file', file);
            
            const response = await fetch('/settings/import_csv', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                statusDiv.textContent = data.message;
                statusDiv.className = 'message success';
                statusDiv.style.display = 'block';
                
                // Clear file input
                fileInput.value = '';
                document.getElementById('fileName').textContent = '';
                
                // Refresh the page after a short delay to show updated schedules
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } else {
                statusDiv.textContent = data.error || '{{ translations.settings.export.error }}';
                statusDiv.className = 'message error';
                statusDiv.style.display = 'block';
            }
            
        } catch (error) {
            console.error('Import error:', error);
            statusDiv.textContent = '{{ translations.settings.export.error }}: ' + error.message;
            statusDiv.className = 'message error';
            statusDiv.style.display = 'block';
        } finally {
            // Restore button state
            importBtn.disabled = fileInput.files.length === 0;
            importBtn.innerHTML = '<i class="fas fa-upload"></i> {{ translations.settings.import.button }}';
            
            // Hide status message after 8 seconds (longer for import due to refresh)
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 8000);
        }
    }
</script>
{% endblock %}